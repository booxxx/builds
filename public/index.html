<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>목표 진행 상황</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 600px; /* 필요에 따라 조절 */
      background-color: white;
      border-radius: 8px;
      padding: 20px 20px 40px; /* 하단 여유 공간 추가 */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative; /* 로그인 버튼을 오른쪽 상단에 배치하기 위해 사용 */
    }

    /* 상단 헤더 스타일: 제목 중앙, 로그인 버튼 오른쪽 */
    .header {
      display: flex;
      align-items: center;
      justify-content: center; /* 제목을 수평 중앙 정렬 */
      margin-bottom: 30px;
      position: relative; /* 버튼 절대 배치를 위해 필요 */
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    #show-login-btn {
      position: absolute;
      right: 0;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }

    /* 각 목표의 카드(진행 상황) 스타일 */
    .progress-container {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .progress-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title-text {
      flex-grow: 1;
    }
    .progress-details {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .progress-bar {
      height: 25px;
      background-color: #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background-color: #90CAF9;
      border-radius: 12px;
      transition: width 0.5s ease-in-out;
    }
    .progress-text {
      position: absolute;
      width: 100%;
      text-align: center;
      color: #333;
      font-weight: bold;
      line-height: 25px;
      font-size: 13px;
    }

    /* 로그인/관리자 패널 스타일 */
    .login-container, .admin-panel {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .hidden {
      display: none;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      background-color: #90CAF9;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #64B5F6;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
    .status-message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .success {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .error-message {
      background-color: #ffebee;
      color: #c62828;
    }
    .admin-panel button {
      width: auto;
      margin-top: 5px;
    }
    .admin-panel h2 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 헤더: 제목 가운데, 로그인 버튼은 오른쪽 -->
    <div class="header">
      <h1>목표 진행 상황</h1>
      <button id="show-login-btn">관리자 로그인</button>
    </div>

    <!-- 목표 목록 영역 -->
    <div id="goals-container"></div>
    
    <!-- 로그인 패널 -->
    <div id="login-container" class="login-container hidden">
      <h2>관리자 로그인</h2>
      <div class="form-group">
        <label for="password">비밀번호:</label>
        <input type="password" id="password" placeholder="관리자 비밀번호를 입력하세요">
      </div>
      <button id="login-btn">로그인</button>
      <button id="cancel-login-btn" style="background-color: #f44336; margin-top: 5px;">취소</button>
      <p id="login-error" class="error hidden">비밀번호가 올바르지 않습니다.</p>
    </div>
    
    <!-- 관리자 기능 패널 -->
    <div id="admin-panel" class="admin-panel hidden">
      <h2>목표 관리</h2>
      
      <div id="edit-form" class="hidden">
        <h3>목표 수정</h3>
        <div class="form-group">
          <label for="edit-title">목표 제목:</label>
          <input type="text" id="edit-title">
        </div>
        <div class="form-group">
          <label for="edit-current">현재 달성 횟수:</label>
          <input type="number" id="edit-current" min="0">
        </div>
        <div class="form-group">
          <label for="edit-total">전체 목표 횟수:</label>
          <input type="number" id="edit-total" min="1" max="100">
        </div>
        <button id="save-edit-btn">저장</button>
        <button id="cancel-edit-btn" style="background-color: #f44336; margin-top: 5px;">취소</button>
      </div>
      
      <div id="add-form">
        <h3>새 목표 추가</h3>
        <div class="form-group">
          <label for="goal-title">목표 제목:</label>
          <input type="text" id="goal-title" placeholder="목표의 제목을 입력하세요">
        </div>
        <div class="form-group">
          <label for="current-count">현재 달성 횟수:</label>
          <input type="number" id="current-count" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="total-count">전체 목표 횟수:</label>
          <input type="number" id="total-count" min="1" max="100" value="10">
        </div>
        <button id="add-goal-btn">목표 추가</button>
      </div>
      
      <div id="status-container"></div>
      
      <button id="logout-btn" style="background-color: #f44336; margin-top: 20px;">로그아웃</button>
    </div>
  </div>

  <script>
    /* ======== 기존 JS 로직 그대로 유지, 스타일/배치만 변경 ======== */

    // 관리자 비밀번호
    const ADMIN_PASSWORD = "2931825";

    // DOM 요소
    const goalsContainer = document.getElementById('goals-container');
    const loginContainer = document.getElementById('login-container');
    const adminPanel = document.getElementById('admin-panel');
    const showLoginBtn = document.getElementById('show-login-btn');
    const loginBtn = document.getElementById('login-btn');
    const cancelLoginBtn = document.getElementById('cancel-login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginError = document.getElementById('login-error');
    const addGoalBtn = document.getElementById('add-goal-btn');
    const editForm = document.getElementById('edit-form');
    const addForm = document.getElementById('add-form');
    const saveEditBtn = document.getElementById('save-edit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const statusContainer = document.getElementById('status-container');

    // 전역 데이터
    let goals = [];
    let currentEditId = null;
    let currentTitleEditId = null;

    // 초기화
    function init() {
      loadGoals();
      // 이벤트 등록
      showLoginBtn.addEventListener('click', showLogin);
      loginBtn.addEventListener('click', attemptLogin);
      cancelLoginBtn.addEventListener('click', hideLogin);
      logoutBtn.addEventListener('click', logout);
      addGoalBtn.addEventListener('click', addGoal);
      saveEditBtn.addEventListener('click', saveEdit);
      cancelEditBtn.addEventListener('click', cancelEdit);
      
      // 엔터 키로 로그인
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          attemptLogin();
        }
      });
    }

    // 로그인 상태 확인
    function isLoggedIn() {
      return sessionStorage.getItem('adminLoggedIn') === 'true';
    }

    // 로그인 폼 표시
    function showLogin() {
      showLoginBtn.classList.add('hidden');
      loginContainer.classList.remove('hidden');
    }

    // 로그인 폼 숨기기
    function hideLogin() {
      loginContainer.classList.add('hidden');
      showLoginBtn.classList.remove('hidden');
      loginError.classList.add('hidden');
      document.getElementById('password').value = '';
    }

    // 로그인 시도
    function attemptLogin() {
      const password = document.getElementById('password').value;
      if (password === ADMIN_PASSWORD) {
        sessionStorage.setItem('adminLoggedIn', 'true');
        loginContainer.classList.add('hidden');
        showLoginBtn.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        loginError.classList.add('hidden');
        renderGoals();
      } else {
        loginError.classList.remove('hidden');
      }
    }

    // 로그아웃
    function logout() {
      sessionStorage.removeItem('adminLoggedIn');
      adminPanel.classList.add('hidden');
      showLoginBtn.classList.remove('hidden');
      renderGoals();
    }

    // 목표 데이터 로드
    function loadGoals() {
      fetch('/api/goals')
        .then(response => {
          if (!response.ok) {
            throw new Error('서버에서 데이터를 불러오는데 실패했습니다');
          }
          return response.json();
        })
        .then(data => {
          goals = data;
          renderGoals();
        })
        .catch(error => {
          console.error('데이터 로딩 에러:', error);
          // 통신 실패 시 기본 데이터 사용
          goals = [
            { id: 1, title: "주 3회 운동하기", current: 2, total: 3 },
            { id: 2, title: "한달 독서 목표", current: 3, total: 10 }
          ];
          renderGoals();
        });
    }

    // 목표 데이터 저장
    function saveGoals() {
      fetch('/api/goals', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(goals)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('데이터 저장에 실패했습니다');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showStatus('데이터가 성공적으로 저장되었습니다.');
        } else {
          showStatus('데이터 저장에 실패했습니다.', true);
        }
      })
      .catch(error => {
        console.error('저장 에러:', error);
        showStatus('서버 통신 중 오류가 발생했습니다.', true);
      });
    }

    // 상태 메시지 표시
    function showStatus(message, isError = false) {
      const statusElement = document.createElement('div');
      statusElement.className = `status-message ${isError ? 'error-message' : 'success'}`;
      statusElement.textContent = message;
      statusContainer.innerHTML = '';
      statusContainer.appendChild(statusElement);
      setTimeout(() => {
        statusElement.remove();
      }, 3000);
    }

    // 목표 렌더링
    function renderGoals() {
      goalsContainer.innerHTML = '';
      if (goals.length === 0) {
        goalsContainer.innerHTML = '<p style="text-align: center; padding: 20px;">등록된 목표가 없습니다.</p>';
        return;
      }
      goals.forEach(goal => {
        const percent = Math.round((goal.current / goal.total) * 100);
        
        const progressContainer = document.createElement('div');
        progressContainer.className = 'progress-container';
        progressContainer.dataset.id = goal.id;
        
        // 제목 영역
        const titleElement = document.createElement('div');
        titleElement.className = 'progress-title';
        
        if (currentTitleEditId === goal.id) {
          // 제목 수정 모드
          const titleInput = document.createElement('input');
          titleInput.type = 'text';
          titleInput.className = 'title-edit-input';
          titleInput.value = goal.title;
          titleInput.id = `title-input-${goal.id}`;
          
          const saveButton = document.createElement('button');
          saveButton.textContent = '저장';
          saveButton.style.marginLeft = '5px';
          saveButton.addEventListener('click', () => saveTitleEdit(goal.id));
          
          const cancelButton = document.createElement('button');
          cancelButton.textContent = '취소';
          cancelButton.style.marginLeft = '5px';
          cancelButton.addEventListener('click', cancelTitleEdit);
          
          titleElement.appendChild(titleInput);
          titleElement.appendChild(saveButton);
          titleElement.appendChild(cancelButton);
        } else {
          // 일반 모드
          const titleTextSpan = document.createElement('span');
          titleTextSpan.className = 'title-text';
          titleTextSpan.textContent = goal.title;
          titleElement.appendChild(titleTextSpan);
          
          // 관리자 모드일 때만 "제목 수정" 버튼
          if (isLoggedIn()) {
            const editTitleButton = document.createElement('button');
            editTitleButton.textContent = '제목 수정';
            editTitleButton.style.marginLeft = '5px';
            editTitleButton.addEventListener('click', () => startTitleEdit(goal.id));
            titleElement.appendChild(editTitleButton);
          }
        }
        
        // 진행도 텍스트
        const detailsElement = document.createElement('div');
        detailsElement.className = 'progress-details';
        detailsElement.innerHTML = `
          <span>${goal.current} / ${goal.total} 완료</span>
          <span>${percent}%</span>
        `;
        
        // 진행 바
        const progressBarElement = document.createElement('div');
        progressBarElement.className = 'progress-bar';
        
        const progressFillElement = document.createElement('div');
        progressFillElement.className = 'progress-fill';
        progressFillElement.style.width = `${percent}%`;
        
        const progressTextElement = document.createElement('div');
        progressTextElement.className = 'progress-text';
        progressTextElement.textContent = `${percent}%`;
        
        progressBarElement.appendChild(progressFillElement);
        progressBarElement.appendChild(progressTextElement);
        
        progressContainer.appendChild(titleElement);
        progressContainer.appendChild(detailsElement);
        progressContainer.appendChild(progressBarElement);
        
        // 관리자 모드에서만 수정/삭제 버튼
        if (isLoggedIn()) {
          const actionButtons = document.createElement('div');
          actionButtons.style.marginTop = '10px';
          actionButtons.style.display = 'flex';
          actionButtons.style.gap = '10px';
          
          const editButton = document.createElement('button');
          editButton.textContent = '수정';
          editButton.style.backgroundColor = '#2196F3';
          editButton.style.flex = '1';
          editButton.addEventListener('click', () => startEdit(goal.id));
          
          const deleteButton = document.createElement('button');
          deleteButton.textContent = '삭제';
          deleteButton.style.backgroundColor = '#f44336';
          deleteButton.style.flex = '1';
          deleteButton.addEventListener('click', () => deleteGoal(goal.id));
          
          actionButtons.appendChild(editButton);
          actionButtons.appendChild(deleteButton);
          progressContainer.appendChild(actionButtons);
        }
        
        goalsContainer.appendChild(progressContainer);
      });
    }

    // 목표 제목 수정(개별)
    function startTitleEdit(id) {
      currentTitleEditId = id;
      renderGoals();
      setTimeout(() => {
        const input = document.getElementById(`title-input-${id}`);
        if (input) {
          input.focus();
          input.select();
        }
      }, 10);
    }
    function saveTitleEdit(id) {
      const input = document.getElementById(`title-input-${id}`);
      if (!input) return;
      const newTitle = input.value.trim();
      if (!newTitle) {
        alert('목표 제목은 비워둘 수 없습니다.');
        return;
      }
      const goalIndex = goals.findIndex(g => g.id === id);
      if (goalIndex >= 0) {
        goals[goalIndex].title = newTitle;
        saveGoals();
      }
      currentTitleEditId = null;
      renderGoals();
    }
    function cancelTitleEdit() {
      currentTitleEditId = null;
      renderGoals();
    }

    // 목표 추가
    function addGoal() {
      const title = document.getElementById('goal-title').value.trim();
      const current = parseInt(document.getElementById('current-count').value);
      const total = parseInt(document.getElementById('total-count').value);
      if (!title) {
        alert('목표 제목을 입력하세요.');
        return;
      }
      if (isNaN(current) || isNaN(total) || current < 0 || total <= 0) {
        alert('유효한 숫자를 입력하세요.');
        return;
      }
      if (total > 100) {
        alert('전체 목표 횟수는 100을 초과할 수 없습니다.');
        return;
      }
      if (current > total) {
        alert('현재 달성 횟수는 전체 목표 횟수보다 클 수 없습니다.');
        return;
      }
      const newId = goals.length > 0 ? Math.max(...goals.map(g => g.id)) + 1 : 1;
      goals.push({ id: newId, title, current, total });
      saveGoals();
      renderGoals();
      document.getElementById('goal-title').value = '';
      document.getElementById('current-count').value = '0';
      document.getElementById('total-count').value = '10';
    }

    // 목표 삭제
    function deleteGoal(id) {
      if (confirm('정말로 이 목표를 삭제하시겠습니까?')) {
        goals = goals.filter(goal => goal.id !== id);
        saveGoals();
        renderGoals();
      }
    }

    // 수정 시작
    function startEdit(id) {
      const goal = goals.find(g => g.id === id);
      if (!goal) return;
      currentEditId = id;
      document.getElementById('edit-title').value = goal.title;
      document.getElementById('edit-current').value = goal.current;
      document.getElementById('edit-total').value = goal.total;
      editForm.classList.remove('hidden');
      addForm.classList.add('hidden');
    }
    // 수정 저장
    function saveEdit() {
      if (currentEditId === null) return;
      const title = document.getElementById('edit-title').value.trim();
      const current = parseInt(document.getElementById('edit-current').value);
      const total = parseInt(document.getElementById('edit-total').value);
      if (!title) {
        alert('목표 제목을 입력하세요.');
        return;
      }
      if (isNaN(current) || isNaN(total) || current < 0 || total <= 0) {
        alert('유효한 숫자를 입력하세요.');
        return;
      }
      if (total > 100) {
        alert('전체 목표 횟수는 100을 초과할 수 없습니다.');
        return;
      }
      if (current > total) {
        alert('현재 달성 횟수는 전체 목표 횟수보다 클 수 없습니다.');
        return;
      }
      const goalIndex = goals.findIndex(g => g.id === currentEditId);
      if (goalIndex >= 0) {
        goals[goalIndex] = { id: currentEditId, title, current, total };
        saveGoals();
        renderGoals();
        cancelEdit();
      }
    }
    // 수정 취소
    function cancelEdit() {
      currentEditId = null;
      editForm.classList.add('hidden');
      addForm.classList.remove('hidden');
    }

    document.addEventListener('DOMContentLoaded', init);

    // 이미 로그인 상태라면 바로 관리자 패널 보이기
    if (isLoggedIn()) {
      showLoginBtn.classList.add('hidden');
      adminPanel.classList.remove('hidden');
    }
  </script>
</body>
</html>
